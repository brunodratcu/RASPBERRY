<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Magic Mirror - Eventos</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

    html,body{height:100%; margin:0;}
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(180deg, #020203 0%, #071018 100%);
      color: #e6fbff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      -webkit-font-smoothing:antialiased;
    }

    /* POPUP */
    .popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.86);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background: linear-gradient(135deg, rgba(10,10,20,0.6), rgba(20,20,30,0.5));
      padding: 28px;
      border: 1px solid rgba(0,240,255,0.18);
      box-shadow: 0 6px 40px rgba(0,240,255,0.05);
      border-radius: 12px;
      width: 320px;
      text-align: center;
      backdrop-filter: blur(4px);
    }

    .popup-content input[type="text"],
    .popup-content input[type="password"]{
      width: 94%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid rgba(0,240,255,0.2);
      background: rgba(0,0,0,0.45);
      color: #e6fbff;
      outline: none;
    }

    .popup-content button {
      margin-top: 8px;
      padding: 10px 16px;
      width: 96%;
      border-radius: 8px;
      border: 1px solid rgba(0,240,255,0.5);
      background: rgba(0,240,255,0.06);
      color: #00dfff;
      cursor: pointer;
      font-weight:700;
    }

    .popup-content h2 { margin: 0 0 8px; color: #00e6ff; }

    /* MAIN PANEL */
    #formContainer {
      display: none;
      width: 640px;
      background: linear-gradient(180deg, rgba(5,8,12,0.6), rgba(8,12,18,0.5));
      border-radius: 14px;
      padding: 28px;
      box-shadow: 0 10px 60px rgba(0,0,0,0.6);
      border: 1px solid rgba(0,240,255,0.08);
    }

    h2 { color: #00e6ff; margin-top:0; }

    form#formEvento input[type="text"],
    form#formEvento input[type="date"],
    form#formEvento select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid rgba(0,240,255,0.12);
      background: rgba(0,0,0,0.45);
      color: #e6fbff;
    }

    form#formEvento button {
      padding: 12px;
      width: 100%;
      margin-top:8px;
      border-radius: 8px;
      border: 1px solid rgba(0,240,255,0.25);
      background: rgba(0,240,255,0.04);
      color: #00dfff;
      font-weight:700;
      cursor: pointer;
    }

    #eventosHoje { margin-top: 18px; }

    ul#listaEventos { list-style:none; padding:0; margin:0; }
    ul#listaEventos li{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 14px;
      border-bottom:1px solid rgba(0,240,255,0.04);
      color:#e6fbff;
      font-size:14px;
    }

    /* bot√£o "x" transparente com letra azul el√©trico */
    .delete-btn {
      background: transparent;
      border: none;
      color: #00bfff; /* azul el√©trico */
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      opacity: 0.95;
    }

    #resetButton {
      margin-top: 14px;
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(0,240,255,0.12);
      background: transparent;
      color: #00bfff; /* azul el√©trico */
      cursor: pointer;
      font-weight:700;
    }
    #resetButton:hover { opacity: 0.9; }

    #mensagemCadastro { color: #9fffdc; min-height:18px; margin-top:6px; }

    /* pequeno responsive */
    @media (max-width:700px){
      #formContainer { width: 92%; }
      .popup-content { width: 90%; }
    }
  </style>
</head>
<body>

<!-- POPUP LOGIN (form para permitir Enter) -->
<div class="popup" id="loginPopup">
  <form class="popup-content" id="formLogin" onsubmit="event.preventDefault(); fazerLogin();">
    <h2>ACESSO</h2>
    <input id="username" type="text" placeholder="Usu√°rio" required autocomplete="username">
    <input id="password" type="password" placeholder="Senha" required autocomplete="current-password">
    <button type="submit">Entrar</button>
    <p id="loginStatus" style="color:#ff6b6b;"></p>
  </form>
</div>

<!-- PAINEL PRINCIPAL -->
<div id="formContainer">
  <h2>Magic Mirror ‚Äî Eventos</h2>

  <form id="formEvento">
    <label for="nome">Nome do Evento:</label>
    <input type="text" name="nome" placeholder="Nome do Evento" required>
    <!-- calend√°rio nativo -->
    <label for="data">Data do Evento:</label>
    <input type="date" name="data" id="data" required>
    <!-- campo de hora livre -->
    <label for="hora">Hora do Evento:</label>
    <input type="time" name="hora" id="hora" required>


    <button type="submit">Cadastrar</button>
    <p id="mensagemCadastro"></p>
  </form>

  <div id="eventosHoje">
    <h3>Eventos de Hoje</h3>
    <ul id="listaEventos"></ul>
    <button id="resetButton" onclick="limparHistorico()">üß® Limpar Hist√≥rico de Eventos</button>
  </div>
</div>

<script>
  // Faz login e oculta popup
  async function fazerLogin(){
    document.getElementById("loginStatus").innerText = "";
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;

    try {
      const res = await fetch("/api/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({username, password})
      });
      const data = await res.json();
      if (res.ok && data.token){
        localStorage.setItem("token", data.token);
        document.getElementById("loginPopup").style.display = "none";
        document.getElementById("formContainer").style.display = "block";
        buscarEventosHoje();
      } else {
        document.getElementById("loginStatus").innerText = data.message || "Erro de login";
      }
    } catch (e) {
      document.getElementById("loginStatus").innerText = "Erro de conex√£o";
      console.error(e);
    }
  }

  // Handle Enter in popup automatically since we're using a <form> with onsubmit

  // Cadastro de evento
  document.getElementById("formEvento").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const form = e.target;
    const evento = {
      nome: form.nome.value,
      data: form.data.value,
      hora: form.hora.value
    };
    const token = localStorage.getItem("token");
    const res = await fetch("/api/eventos", {
      method: "POST",
      headers: {"Content-Type":"application/json","Authorization": `Bearer ${token}`},
      body: JSON.stringify(evento)
    });
    const json = await res.json();
    const mensagemElem = document.getElementById("mensagemCadastro");
    if (res.ok){
      mensagemElem.innerText = "Evento cadastrado com sucesso!";
      form.reset();
      buscarEventosHoje();
      setTimeout(()=> mensagemElem.innerText = "", 3000);
    } else {
      mensagemElem.innerText = json.message || "Erro ao cadastrar";
    }
  });

  // Buscar eventos do dia
  async function buscarEventosHoje(){
    const token = localStorage.getItem("token");
    if(!token) return;
    try {
      const res = await fetch("/api/eventos-hoje", { headers: {"Authorization": `Bearer ${token}`}});
      if (!res.ok) { console.error("fetch eventos hoje", await res.text()); return; }
      const eventos = await res.json();
      const lista = document.getElementById("listaEventos");
      lista.innerHTML = "";
      if (eventos.length === 0){
        lista.innerHTML = "<li>Nenhum evento hoje.</li>";
      } else {
        eventos.forEach(ev => {
          const li = document.createElement("li");
          li.innerHTML = `
            <span>${ev.nome} ‚Äî ${ev.hora}</span>
            <button class="delete-btn" onclick="deletarEvento(${ev.id})">‚úñ</button>
          `;
          lista.appendChild(li);
        });
      }
    } catch (e){
      console.error("Erro buscarEventosHoje:", e);
    }
  }

  // Deletar √∫nico evento
  async function deletarEvento(id){
    const token = localStorage.getItem("token");
    if(!token) { alert("Fa√ßa login"); return; }
    if(!confirm("Excluir esse evento?")) return;
    try {
      const res = await fetch(`/api/eventos/${id}`, { method:"DELETE", headers: {"Authorization": `Bearer ${token}`}});
      if (res.ok) buscarEventosHoje();
      else alert("Falha ao excluir");
    } catch (e) { alert("Erro de rede"); console.error(e); }
  }

  // Limpar hist√≥rico (deleta todos)
  async function limparHistorico(){
    const token = localStorage.getItem("token");
    if(!token) { alert("Fa√ßa login"); return; }
    if(!confirm("Tem certeza que quer apagar todos os eventos?")) return;
    try {
      const res = await fetch("/api/eventos", { method:"DELETE", headers: {"Authorization": `Bearer ${token}`}});
      if (res.ok) { alert("Hist√≥rico apagado"); buscarEventosHoje(); }
      else alert("Erro ao apagar");
    } catch (e) { alert("Erro de rede"); console.error(e); }
  }

  // opcional: auto foco no campo username ao carregar
  window.addEventListener("load", ()=> document.getElementById("username").focus());
</script>

</body>
</html>
